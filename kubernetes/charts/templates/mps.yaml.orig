#/*********************************************************************
# Copyright (c) Intel Corporation 2020
# SPDX-License-Identifier: Apache-2.0
#**********************************************************************/
apiVersion: v1
kind: Service
metadata:
  labels:
    {{- include "installServersChart.labels" . | nindent 4 }}
    app: mps
  name: {{ .Release.Name }}-mps
spec:
  ports:
  - port: 4433
    name: cira
    protocol: TCP
    targetPort: 4433
  - port: 3000
    name: webapi
    protocol: TCP
    targetPort: 3000
  selector:
    {{- include "installServersChart.labels" . | nindent 4 }}
    app: mps
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-mps
  labels:
    {{- include "installServersChart.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.mps.replicaCount }}
  selector:
    matchLabels:
      {{- include "installServersChart.selectorLabels" . | nindent 6 }}
      app: mps
  template:
    metadata:
      labels:
        {{- include "installServersChart.labels" . | nindent 8 }}
        app: mps
    spec:
      {{- include "installServersChart.imagePullSecrets" . | nindent 6 }}
      {{- if .Values.mps.extraVolumes }}
      volumes:
        {{- toYaml .Values.mps.extraVolumes | nindent 8 }}
      {{- end }}
      containers:
        - name: mps
          image: {{ .Values.images.mps }}
          env:
            - name: "MPS_LOG_LEVEL"
              value: "{{ .Values.mps.logLevel }}"   
            - name: "MPS_COMMON_NAME"
              value: "{{ .Values.mps.commonName }}"
            - name: "MPS_CONNECTION_STRING"
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secret
                  key: mpsdb-connection-string
            - name: "MPS_VAULT_ADDRESS"
              value: {{ .Values.vault.address | quote }}
            - name: "MPS_SECRETS_PATH"
              value: {{ .Values.vault.secretsPath | quote }}
            - name: "MPS_PORT"
              value: '4433'
            - name: "MPS_INSTANCE_NAME"
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: "MPS_JWT_EXPIRATION"
              value: "{{ .Values.mps.jwtExpiration }}"
            - name: "MPS_JWT_SECRET"
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secret
                  key: jwt-secret
            - name: "MPS_JWT_ISSUER"
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-secret
                  key: jwt-issuer
            - name: MPS_WEB_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-web-admin
                  key: user
            - name: MPS_WEB_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-web-admin
                  key: password
            - name: MPS_VAULT_TOKEN
              {{- toYaml .Values.vault.tokenEnv | nindent 14 }}
            - name: MPS_MQTT_ADDRESS
              value: "mqtt://{{ .Release.Name }}-mosquitto:1883"
            {{- if .Values.mps.extraEnvVars }}
            {{- include "common.tplvalues.render" (dict "value" .Values.mps.extraEnvVars "context" $) | nindent 12 }}
            {{- end }}
          {{- if .Values.mps.extraVolumeMounts }}
          volumeMounts:
          {{- include "common.tplvalues.render" (dict "value" .Values.mps.extraVolumeMounts "context" $) | nindent 12 }}
          {{- end }}
          ports:
            - containerPort: 3000
              name: mps
            - containerPort: 4433
              name: mpsws
